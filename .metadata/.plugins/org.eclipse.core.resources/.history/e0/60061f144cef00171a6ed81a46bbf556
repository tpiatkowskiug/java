package dao;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.LinkedList;
import java.util.List;
 
import model.Klient;
//import model.Ksiazka;
 
public class SqliteKlientDAO{
 
    public static final String DRIVER = "org.sqlite.JDBC";
    public static final String DB_URL = "jdbc:sqlite:biblioteka.db";
 
    private Connection conn;
    private Statement stat;
 
    public SqliteKlientDAO() {
        try {
            Class.forName(SqliteKlientDAO.DRIVER);
        } catch (ClassNotFoundException e) {
            System.err.println("Brak sterownika JDBC");
            e.printStackTrace();
        }
 
        try {
            conn = DriverManager.getConnection(DB_URL);
            stat = conn.createStatement();
        } catch (SQLException e) {
            System.err.println("Problem z otwarciem polaczenia");
            e.printStackTrace();
        }
 
        createTables();
    }
 
    public boolean createTables()  {
        String createCzytelnicy = "CREATE TABLE IF NOT EXISTS czytelnicy (id_czytelnika INTEGER PRIMARY KEY AUTOINCREMENT, imie varchar(255), nazwisko varchar(255), pesel int)";
        String createKsiazki = "CREATE TABLE IF NOT EXISTS ksiazki (id_ksiazki INTEGER PRIMARY KEY AUTOINCREMENT, tytul varchar(255), autor varchar(255))";
        String createWypozyczenia = "CREATE TABLE IF NOT EXISTS wypozyczenia (id_wypozycz INTEGER PRIMARY KEY AUTOINCREMENT, id_czytelnika int, id_ksiazki int)";
        try {
            stat.execute(createCzytelnicy);
            stat.execute(createKsiazki);
            stat.execute(createWypozyczenia);
        } catch (SQLException e) {
            System.err.println("Blad przy tworzeniu tabeli");
            e.printStackTrace();
            return false;
        }
        return true;
    }
 
    public boolean insertCzytelnik(String imie, String nazwisko, String pesel) {
        try {
            PreparedStatement prepStmt = conn.prepareStatement(
                    "insert into czytelnicy values (NULL, ?, ?, ?);");
            prepStmt.setString(1, imie);
            prepStmt.setString(2, nazwisko);
            prepStmt.setString(3, pesel);
            prepStmt.execute();
        } catch (SQLException e) {
            System.err.println("Blad przy wstawianiu czytelnika");
            e.printStackTrace();
            return false;
        }
        return true;
    }
 
    public boolean insertKsiazka(String tytul, String autor) {
        try {
            PreparedStatement prepStmt = conn.prepareStatement(
                    "insert into ksiazki values (NULL, ?, ?);");
            prepStmt.setString(1, tytul);
            prepStmt.setString(2, autor);
            prepStmt.execute();
        } catch (SQLException e) {
            System.err.println("Blad przy wypozyczaniu");
            return false;
        }
        return true;
    }
 
    public boolean insertWypozycz(int idCzytelnik, int idKsiazka) {
        try {
            PreparedStatement prepStmt = conn.prepareStatement(
                    "insert into wypozyczenia values (NULL, ?, ?);");
            prepStmt.setInt(1, idCzytelnik);
            prepStmt.setInt(2, idKsiazka);
            prepStmt.execute();
        } catch (SQLException e) {
            System.err.println("Blad przy wypozyczaniu");
            return false;
        }
        return true;
    }
 
    public List<Czytelnik> selectCzytelnicy() {
        List<Czytelnik> czytelnicy = new LinkedList<Czytelnik>();
        try {
            ResultSet result = stat.executeQuery("SELECT * FROM czytelnicy");
            int id;
            String imie, nazwisko, pesel;
            while(result.next()) {
                id = result.getInt("id_czytelnika");
                imie = result.getString("imie");
                nazwisko = result.getString("nazwisko");
                pesel = result.getString("pesel");
                czytelnicy.add(new Czytelnik(id, imie, nazwisko, pesel));
            }
        } catch (SQLException e) {
            e.printStackTrace();
            return null;
        }
        return czytelnicy;
    }
 
    public List<Ksiazka> selectKsiazki() {
        List<Ksiazka> ksiazki = new LinkedList<Ksiazka>();
        try {
            ResultSet result = stat.executeQuery("SELECT * FROM ksiazki");
            int id;
            String tytul, autor;
            while(result.next()) {
                id = result.getInt("id_ksiazki");
                tytul = result.getString("tytul");
                autor = result.getString("autor");
                ksiazki.add(new Ksiazka(id, tytul, autor));
            }
        } catch (SQLException e) {
            e.printStackTrace();
            return null;
        }
        return ksiazki;
    }
 
    public void closeConnection() {
        try {
            conn.close();
        } catch (SQLException e) {
            System.err.println("Problem z zamknieciem polaczenia");
            e.printStackTrace();
        }
    }
}
//import java.sql.Connection;
//import java.sql.PreparedStatement;
//import java.sql.ResultSet;
//import java.sql.SQLException;
//import java.sql.Statement;
//import java.util.ArrayList;
//import java.util.List;
//
//import org.apache.log4j.Logger;
//
//
//import model.Klient;
//
//public class SqliteKlientDAO implements IKlientDAO {
//
//	private static final Logger logger = Logger.getLogger(SqliteKlientDAO.class);
//    
//	private static final String CREATE_QUERY = 
//			"INSERT INTO klient(imie, nazwisko, miasto, rok_urodzenia)  VALUES (?,?,?,?)";
//    private static final String READ_QUERY = 
//    		"SELECT id, imie, nazwisko, miasto, rok_urodzenia FROM klient WHERE id = ?";
//    private static final String READALL_QUERY = 
//    		"SELECT id, imie, nazwisko, miasto, rok_urodzenia FROM klient";
//    private static final String UPDATE_QUERY = 
//    		"UPDATE klient SET imie=?, nazwisko=?, miasto=?,rok_urodzenia=?  WHERE id = ?";
//    private static final String DELETE_QUERY = 
//    		"DELETE FROM klient WHERE id = ?";
//	private static final String CREATE_TABLE = 
//			"CREATE TABLE klient(id INTEGER PRIMARY KEY AUTOINCREMENT,imie CHAR(50), nazwisko CHAR(50), miasto CHAR(50), rok_urodzenia INT)";
// 
//	//@Override
//	public int create(Klient klient) {
//		logger.info("create klient");
//		Connection conn = null;
//        PreparedStatement preparedStatement = null;
//        ResultSet result = null;
//        try {
//            conn = SqliteDAOFactory.createConnection();
//            preparedStatement = conn.prepareStatement(CREATE_QUERY,
//                    Statement.RETURN_GENERATED_KEYS);
//            preparedStatement.setString(1, klient.getImie());
//            preparedStatement.setString(2, klient.getNazwisko());
//            preparedStatement.setString(3, klient.getMiasto());
//            preparedStatement.setInt(4, klient.getRokUrodzenia());
//            preparedStatement.execute();
//            result = preparedStatement.getGeneratedKeys();
// 
//            if (result.next() && result != null) {
//                return result.getInt(1);
//            } else {
//                return -1;
//            }
//        } catch (SQLException e) {
//            logger.error(e.getMessage());
//        } finally {
//            try {
//                result.close();
//            } catch (Exception rse) {
//                logger.error(rse.getMessage());
//            }
//            try {
//                preparedStatement.close();
//            } catch (Exception sse) {
//                logger.error(sse.getMessage());
//            }
//            try {
//                conn.close();
//            } catch (Exception cse) {
//                logger.error(cse.getMessage());
//            }
//        }
//        return -1;
//	}
//
//	//@Override
//	public Klient read(int id) {
//		Klient klient = null;
//        Connection conn = null;
//        PreparedStatement preparedStatement = null;
//        ResultSet result = null;
//        try {
//        	conn = SqliteDAOFactory.createConnection();
//            preparedStatement = conn.prepareStatement(READ_QUERY);
//            preparedStatement.setInt(1, id);
//            preparedStatement.execute();
//            result = preparedStatement.getResultSet();
// 
//            if (result.next() && result != null) {
//            	klient = new Klient(result.getInt(1), 
//            						result.getString(2), 
//            						result.getString(3), 
//            						result.getString(4), 
//            						result.getInt(5));
//            } else {
//                // TODO
//            	logger.info("Brak klienta o ID = "+ id);
//            }
//        } catch (SQLException e) {
//            logger.error(e.getMessage());
//        } finally {
//            try {
//                result.close();
//            } catch (Exception rse) {
//                logger.error(rse.getMessage());
//            }
//            try {
//                preparedStatement.close();
//            } catch (Exception sse) {
//                logger.error(sse.getMessage());
//            }
//            try {
//                conn.close();
//            } catch (Exception cse) {
//                logger.error(cse.getMessage());
//            }
//        }
//        return klient;
//	}
//
//	//@Override
//	public List<Klient> readAll() {
//		logger.info("create readAll");
//		List<Klient> lista_klientow = new ArrayList<Klient>();
//        Connection conn = null;
//        PreparedStatement preparedStatement = null;
//        ResultSet result = null;
//        try {
//        	conn = SqliteDAOFactory.createConnection();
//            preparedStatement = conn.prepareStatement(READALL_QUERY);
//            preparedStatement.execute();
//            result = preparedStatement.getResultSet();
//            //result = preparedStatement.executeQuery();
//            if (result != null){
//            while(result.next())
//            	lista_klientow.add(
//            					new Klient(
//            							result.getInt(1), 
//            							result.getString(2), 
//            							result.getString(3), 
//            							result.getString(4), 
//            							result.getInt(5)
//            							)
//            					);
//            } else {
//                // TODO
//            	logger.info("Brak klientów");
//            }
//        } catch (SQLException e) {
//            logger.error(e.getMessage()+"błąd listy klientów");
//        } finally {
//            try {
//                result.close();
//            } catch (Exception rse) {
//                logger.error(rse.getMessage());
//            }
//            try {
//                preparedStatement.close();
//            } catch (Exception sse) {
//                logger.error(sse.getMessage());
//            }
//            try {
//                conn.close();
//            } catch (Exception cse) {
//                logger.error(cse.getMessage());
//            }
//        }
//        return lista_klientow;
//	}
//
//	//@Override
//	public boolean update(Klient klient) {
//        Connection conn = null;
//        PreparedStatement preparedStatement = null;
//        try {
//        	conn = SqliteDAOFactory.createConnection();
//            preparedStatement = conn.prepareStatement(UPDATE_QUERY);
//            preparedStatement.setString(1, klient.getImie());
//            preparedStatement.setString(2, klient.getNazwisko());
//            preparedStatement.setString(3, klient.getMiasto());
//            preparedStatement.setInt(4, klient.getRokUrodzenia());
//            preparedStatement.setInt(5, klient.getId());
//            preparedStatement.execute();
//            return true;
//        } catch (SQLException e) {
//            logger.error(e.getMessage());
//        } finally {
//            try {
//                preparedStatement.close();
//            } catch (Exception sse) {
//                logger.error(sse.getMessage());
//            }
//            try {
//                conn.close();
//            } catch (Exception cse) {
//                logger.error(cse.getMessage());
//            }
//        }
//        return false;
//	}
//
//	//@Override
//	public boolean delete(int id) {
//		Connection conn = null;
//	    PreparedStatement preparedStatement = null;
//	    try {
//	    	conn = SqliteDAOFactory.createConnection();
//	    	preparedStatement = conn.prepareStatement(DELETE_QUERY);
//	    	preparedStatement.setInt(1, id);
//	    	preparedStatement.execute();
//	    	return true;
//	    } catch (SQLException e) {
//	    	logger.error(e.getMessage());
//	    } finally {
//	    	try {
//	    		preparedStatement.close();
//	    	} catch (Exception sse) {
//	    		logger.error(sse.getMessage());
//	    	}
//	    	try {
//	    		conn.close();
//	        } catch (Exception cse) {
//	        	logger.error(cse.getMessage());
//	        }
//	    }
//	    return false;
//	}
//	
//	//@Override
//	public void createTable(){
//		Connection conn = null;
//		Statement stmt = null;
//		try {
//			logger.info("Get CREATE_TABLE");
//	    	conn = SqliteDAOFactory.createConnection();
//	    	logger.info("Get CREATE_TABLE połączenie");
//	    	stmt = conn.createStatement();
//	    	stmt.executeUpdate(CREATE_TABLE);
//		} catch (SQLException e) {
//	    	logger.error(e.getMessage());
//		} finally {
//	    	try {
//	    		stmt.close();
//	    	} catch (Exception sse) {
//	    		logger.error(sse.getMessage());
//	    	}
//	    	try {
//	    		conn.close();
//	        } catch (Exception cse) {
//	        	logger.error(cse.getMessage());
//	        }
//		}
//	}
//}